---
title: "TAMANI Project DiD"
subtitle: "3PO Meeting"  
author: "Sam Harper"
institute: " <br> </br>"
date: 2021-11-23
output:
  xaringan::moon_reader:
    lib_dir: libs
    css: [xaringan-themer.css, style.css]
    nature:
      beforeInit: "macros.js"
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      ratio: "16:9"
---

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)
library(DiagrammeR)
library(xaringan)
library(leaflet)
library(ggplot2)
# library(emo)
xfun::pkg_load2(c('tikzDevice', 'magick', 'pdftools'))
```

```{r, include=FALSE}
pdf2png = function(path) {
  # only do the conversion for non-LaTeX output
  if (knitr::is_latex_output()) return(path)
  path2 = xfun::with_ext(path, "png")
  img = magick::image_read_pdf(path)
  magick::image_write(img, path2, format = "png")
  path2
}
```

```{r xaringan-themer, include=FALSE}
library(xaringanthemer)
write_xaringan_theme(text_color = "#000000", header_color = "#737373", text_font_size = "24px",  text_font_family = "'Lucida Sans'", header_font_google = google_font("Source Sans Pro"), title_slide_background_color =  "#ffffff", title_slide_text_color = "#000000", link_color = "#0000ee", footnote_font_size = "0.5em")
```
## Basic setup for DD with variable timing
Say different states/provinces are exposed to a policy at different times.   
We often use OLS (or LPM) to fit:
$$y_{it} = \alpha_{i} + \tau_{t} + \beta^{DD}{D_{it}} + \epsilon_{it}$$
### where
- $y_{it}$ is the outcome for unit $i$ at time $t$.
- $\alpha_{i}$ are unit-specific fixed effects.
- $\tau_{t}$ are fixed effects for each time period.
- $D_{it}$ is a time-varying treatment indicator.
- $\beta^{DD}$ is the difference-in-differences estimate.

---
# CIHR study objectives
## Impact of the combined coal ban and heat pump subsidy on:

.right-column[

1. Community and personal air pollution;

2. Indoor temperatures in homes;

3. Health outcomes.

]

---
### Next phase of project (HEI grant)

---
## HEI study objectives
.right-column[
### Aim 1.
#### Estimate the total effect of the intervention.

### Aim 2. 
#### Estimate the contribution of changes in the chemical composition of $PM_{2.5}$ to the overall effect on health outcomes.

### Aim 3. 
#### Examine alternative (i.e., non $PM_{2.5}$) .orange[pathways and mechanisms] that may contribute to the interventionâ€™s impact.
]

---
## Basic idea for mediation study


### To understand the pathways, mechanisms, and intermediates through which a treatment affects an outcome.

--

.right-column[
###How much of the policy effect is through:
#### Reduced exposure to $PM_{2.5}$
#### Other pathways (behavioral changes?)
#### Also consider multiple mediators
]

---
## New measurements proposed for HEI study
.right-column[
### 3rd data campaign in winter ~~2020/21~~ 2021/22. 
- Objective measurement of household stove use.

- 24h indoor (household) $PM_{2.5}$ concentrations. 

- Analysis of community, indoor, and personal exposure PM2.5 samples for chemical composition and molecular tracers for household coal burning. 
]

---
# First part of mediation: total effect
.left-column[
Basic idea is to understand pathways of effects  

First step is to estimate the total effect of exposure $T$ on outcomes.
]

.right-column[
```{r dag1, engine='tikz', echo=F}
\begin{tikzpicture}[shorten > = 1pt, line width=1.5pt]
\tikzstyle{every node} = [rectangle, fill=white, draw=none]
\node (t) at  (0,0) [align=center] {Policy\\($T$)};
%\node (m) at  (3,0) [align=center] {PM\textsubscript{2.5}\\($M$)};
\node (y) at  (6,0) [align=center] {Blood\\pressure\\($Y$)};
% \node (de) at (3,1.6) [align=center, text=red!80] {\small{Direct effect}};
\node (te) at (3,-0.6) [align=center,text=red!80] {\small{Total effect}};
\draw [->] (t) to (y);
\end{tikzpicture}
```
]

---
# Second part of mediation: decomposition
.left-column[
Basic idea is to understand pathways of effects  

How much of the effect is due to $PM_{2.5}$ vs. other pathways?
]

.right-column[
```{r dag2, engine='tikz', echo=F}
\begin{tikzpicture}[shorten > = 1pt, line width=1.5pt]
\tikzstyle{every node} = [rectangle, fill=white, draw=none]
\node (t) at  (0,0) [align=center] {Policy\\($T$)};
\node (m) at  (3,0) [align=center] {PM\textsubscript{2.5}\\($M$)};
\node (y) at  (6,0) [align=center] {Blood\\pressure\\($Y$)};
\node (de) at (3,1.6) [align=center, text=red!80] {\small{Direct effect}};
\node (ie) at (3,-0.6) [align=center,text=red!80] {\small{Indirect effect}};
\foreach \from/\to in {t/m, m/y}
  \draw [->] (\from) -- (\to);
\draw [->] (t) to [bend left=35] (y);
\end{tikzpicture}
```
]

---
# Basic DAG for mediation
.pull-left[
### $X$ = pre-treatment covariates
### $T$ = exposure
### $M$ = mediator
### $W$ = confounders
### $Y$ = outcome
]

.pull-right[
```{r,engine='tikz', echo=FALSE}
\begin{tikzpicture}[shorten > = 1pt, line width=1pt]
\tikzstyle{every node} = [rectangle, fill=white, draw=none]
\node (x) at (0,0) [align=center] {$X$};
\node (t) at  (1.5,0) [align=center] {Policy\\($T$)};
%\node (tt) at (0.5,-1) [align=left] {\footnotesize{$T$: Policy}};
\node (m) at  (3.5,0) [align=center] {PM\textsubscript{2.5}\\($M$)};
%\node (mt) at (0.5,-1.4) [align=left] {\footnotesize{$M$: PM~2.5~}};
\node (y) at  (5.5,0) [align=center] {SBP\\($Y$)};
%\node (yt) at (0.5,-1.8) [align=left] {\footnotesize{$Y$: SBP  }};
\node (w) at (3.5,-1.5) [align=center] {$W$};
% \node (u) at (4.5, -1.5) [align=center] {\textcolor{gray!30}{$U$}};
\foreach \from/\to in {x/t, t/m, m/y, w/m, w/y}
  \draw [->] (\from) -- (\to);
%\foreach \from/\to in {u/m, u/y}
  %\draw [->, color=gray!30] (\from) -- (\to);
\draw [->] (t) to [bend left=45] (y);
\draw [->] (x) to [bend left=45] (y.north);
\draw [->] (x.north) to [bend left=45] (m);
\end{tikzpicture}
```
]

---
# Basic DAG for mediation
.pull-left[
### $X$ = pre-treatment covariates
### $T$ = exposure
### $M$ = mediator
### $W$ = confounders
### $Y$ = outcome
]

.pull-right[
```{r,engine='tikz', echo=FALSE}
\begin{tikzpicture}[shorten > = 1pt, line width=1pt]
\tikzstyle{every node} = [rectangle, fill=white, draw=none]
\node (x) at (0,0) [align=center] {$X$};
\node (t) at  (1.5,0) [align=center] {Policy\\($T$)};
%\node (tt) at (0.5,-1) [align=left] {\footnotesize{$T$: Policy}};
\node (m) at  (3.5,0) [align=center] {PM\textsubscript{2.5}\\($M$)};
%\node (mt) at (0.5,-1.4) [align=left] {\footnotesize{$M$: PM~2.5~}};
\node (y) at  (5.5,0) [align=center] {SBP\\($Y$)};
%\node (yt) at (0.5,-1.8) [align=left] {\footnotesize{$Y$: SBP  }};
\node (w) at (3.5,-1.5) [align=center] {$W$};
\node (u) at (4.5, -1.5) [align=center] {\textcolor{gray!30}{$U$}};
\foreach \from/\to in {x/t, t/m, m/y, w/m, w/y}
  \draw [->] (\from) -- (\to);
\foreach \from/\to in {u/m, u/y}
  \draw [->, color=gray!30] (\from) -- (\to);
\draw [->] (t) to [bend left=45] (y);
\draw [->] (x) to [bend left=45] (y.north);
\draw [->] (x.north) to [bend left=45] (m);
\end{tikzpicture}
```
]

---
background-image: url(basic-dag.png)
background-position: top right
background-size: 450px 275px
# Quantities of interest
## Estimate two regressions:
$$\color{red}{E[Y|T,X]=\beta_{0}+\beta_{1}T +\beta_{2}X}$$
$$E[Y|T,X,M] = \gamma_{0} + \gamma_{1}T + \gamma_{2}M + \gamma_{3}TM + \gamma_{4}X + \gamma_{5}W$$

--

### First equation estimates the total effect of the ban:
$$\color{red}{TE=\beta_{1}(T^{*}-T)}$$
where $T^{*}$ is exposure to ban and $T$ is no exposure.

---
background-image: url(basic-dag.png)
background-position: top right
background-size: 450px 275px
# Quantities of interest
## Estimate two regressions:
$$E[Y|T,X]=\beta_{0}+\beta_{1}T +\beta_{2}X$$
$$\color{red}{E[Y|T,X,M] = \gamma_{0} + \gamma_{1}T + \gamma_{2}M + \gamma_{3}TM + \gamma_{4}X + \gamma_{5}W}$$


### Second equation estimates the "Controlled Direct Effect":
$$\color{red}{CDE=\gamma_{1}+\gamma_{3}TM}$$

---
# Key assumptions
.right-column[
### Assumptions for valid CDE:
#### No confounding of the total effect.
#### No confounding of the mediator-outcome effect.
#### No confounding of the exposure-mediator effect.
]
---
# What the hell is the CDE?

.pull-left[
*This effect is the contrast between the counterfactual outcome if the individual were exposed at $T=t$ and the counterfactual outcome if the same individual were exposed at* $T=t*$, *with the mediator set to a fixed level* $M=m$.
]

--

.pull-right[
English:
### "By how much would blood pressure change if the policy were implemented and we held $PM_{2.5}$ fixed?"
]

---
.left-column[
### Extension to multiple mediators
More complicated

Sequential mediatiors?

Interactions between mediators?

]

.right-column[
```{r mm, engine='tikz', echo=F}
\begin{tikzpicture}[shorten > = 1pt, line width=1pt]
\tikzstyle{every node} = [rectangle, fill=white, draw=none]
\node (x) at (0,0) [align=center] {$X$};
\node (t) at  (1.5,0) [align=center] {Policy\\($T$)};
\node (m1) at  (3.5,1) [align=center] {PM\textsubscript{2.5}\\($M_{1}$)};
\node (m2) at  (3.5,-1) [align=center] {Indoor\\Temp\\($M_{2}$)};
\node (y) at  (5.5,0) [align=center] {SBP\\($Y$)};
\node (w) at (2,-1.5) [align=center] {$W$};
\foreach \from/\to in {x/t, t/y, t/m1, t/m2, m1/y, m2/y, w/m1, w/m2}
  \draw [->] (\from) -- (\to);
\draw [->] (x) to [bend left=45] (y.north);
\draw [->] (x) to [bend left=20] (m1);
\draw [->] (x) to [bend right=25] (m2);
\draw [->] (w) to [bend right=45] (y);
\end{tikzpicture}
```
]
