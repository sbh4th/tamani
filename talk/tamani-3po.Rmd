---
title: "TAMANI Project DiD"
subtitle: "3PO Meeting"  
author: "Sam Harper"
institute: " <br> </br>"
date: 2021-11-23
output:
  xaringan::moon_reader:
    lib_dir: libs
    css: [xaringan-themer.css, style.css]
    nature:
      beforeInit: "macros.js"
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      ratio: "16:9"
---

```{r setup, include=FALSE}
library(here)
options(htmltools.dir.version = FALSE)
library(DiagrammeR)
library(xaringan)
library(leaflet)
library(ggplot2)
library(kableExtra)
library(fixest)
library(modelsummary)
devtools::install_github("bcallaway11/did")
library(did)
# library(emo)
xfun::pkg_load2(c('tikzDevice', 'magick', 'pdftools'))
```

```{r, include=FALSE}
pdf2png = function(path) {
  # only do the conversion for non-LaTeX output
  if (knitr::is_latex_output()) return(path)
  path2 = xfun::with_ext(path, "png")
  img = magick::image_read_pdf(path)
  magick::image_write(img, path2, format = "png")
  path2
}
```

```{r xaringan-themer, include=FALSE}
library(xaringanthemer)
write_xaringan_theme(text_color = "#000000", header_color = "#737373", text_font_size = "24px",  text_font_family = "'Lucida Sans'", header_font_google = google_font("Source Sans Pro"), title_slide_background_color =  "#ffffff", title_slide_text_color = "#000000", link_color = "#0000ee", footnote_font_size = "0.5em")
```
## Basic setup for DD with variable timing
Say different states/provinces are exposed to a policy at different times.   
We often use OLS (or LPM) to fit:
$$y_{it} = \alpha_{i} + \tau_{t} + \beta^{DD}{D_{it}} + \epsilon_{it}$$
### where
- $y_{it}$ is the outcome for unit $i$ at time $t$.
- $\alpha_{i}$ are unit-specific fixed effects.
- $\tau_{t}$ are fixed effects for each time period.
- $D_{it}$ is a time-varying treatment indicator.
- $\beta^{DD}$ is the difference-in-differences estimate.

---
# Key points from Goodman-Bacon (2019)
.right-column[
- ### With OLS, DD with treatment timing is a variance-weighted average.
- ### Weights are a function of both group sizes *and* variances.
- ### Can lead to $\beta^{DD}$ that is a poor summary of group-specific effects.
]

---
.footnote[Graph from https://andrewcbaker.netlify.app/2019/09/25/difference-in-differences-methodology/]

.left-column[
1. Early-adopters (*k*) vs. never treated (*U*)

2. Later-adopters (*l*) vs. never treated (*U*).

3. Early (*k*) vs. later (*l*) adopters.

4. *Later (l) vs. earlier (k) adopters.*
]
.right-column[.center[
![:scale 90%](baker-f1.png)]]

---
## Tabora Maternal Newborn Health Initiative (TAMANI) 
.footnote[Source: https://commons.wikimedia.org/w/index.php?curid=47130439, Google Maps]

.pull-right[
```{r,  echo=F, out.width = 250}
knitr::include_graphics(here("talk", "Tabora.png"))
```
]

.pull-left[
```{r,  echo=F, out.width = 250}
knitr::include_graphics(here("talk", "tanzania.png"))
```
]

---
.right-column[
### Aim 1.
#### Assess the impact of CARE’s multi-component intervention on several indicators of reproductive maternal and newborn health. 

### Aim 2. 
#### Estimate the contribution of changes in the chemical composition of $PM_{2.5}$ to the overall effect on health outcomes.

### Aim 3. 
#### Examine alternative (i.e., non $PM_{2.5}$) .orange[pathways and mechanisms] that may contribute to the intervention’s impact.
]

---
## Who is treated?
.pull-right[
```{r,  echo=F, out.width = 250}
knitr::include_graphics(here("talk", "tanzania.png"))
```
]

---
## Data structure: Individual-level
.left-column[
- sba_birth = SBA present

- txdel = treated

- time = survey wave

- pid = person ID

- group = time when group first treated 

]

.right-column[
```{r d_ind, echo=FALSE}
d_ind <- readRDS(file = here("data-clean", "d_ind.rds"))

kable(head(d_ind)) %>%
  kable_styling()
```
]

---
## Data structure: Pooled by district
.left-column[
- tsba = total SBA births
- tpop = total pop

- txdel = treated

- time = survey wave

- group = time when group first treated 

]

.right-column[
```{r d_agg, echo=FALSE}
d_sba <- readRDS(file = here("data-clean", "d_sba.rds"))

kable(head(d_sba, n=9L), digits=3) %>%
  kable_styling()
```
]

---
## TWFE models (OLS)
.pull-left[
$$y_{sba} = \alpha + \beta*txdel + \gamma_{district} + \delta_{time} + \epsilon$$

- Individual and aggregate data basically identical

- Clustered SEs are also approximately the same

]
.pull-right[
```{r twfe1, echo=FALSE}
# Individual-level
twfe <- fixest::feols(sba_birth ~ txdel | district + time, 
                      data = d_ind,
                      weights = NULL, 
                      cluster = ~district)

# Pooled
twfep <- fixest::feols(psba ~ txdel | district + time, 
                      data = d_sba,
                      weights = ~tpop, 
                      cluster = ~district)

models <- list("Individual" = twfe, "Aggregate" = twfep)
modelsummary(models, gof_omit = 'DF|Deviance|R2|AIC|BIC|Log.Lik')
```
]

---
## CS Approach: Aggregate to Group-Time cohorts
```{r gt, echo=FALSE, message=FALSE}
# create group-time aggregate data
d_agg <- d_sba %>% group_by(group, time) %>%
  summarise(tsba = sum(tsba),
         tpop = sum(tpop),
         psba = tsba / tpop, # % SBA
         txdel = mean(txdel))

gt <- d_agg %>% select(group, time, psba, tpop) %>%
  pivot_wider(names_from = time, names_prefix = "t",
              values_from = c(psba, tpop))

gt %>%
  kbl(digits=3, col.names = c("Group", "Time1", "Time2", "Time3", "Time4",
          "Time5", "Time1", "Time2", "Time3", "Time4", "Time5")) %>%
  kable_styling()

```

---
## Group-Time 2x2 for Group 2


---
# First part of mediation: total effect
.left-column[
Basic idea is to understand pathways of effects  
]

---
# Second part of mediation: decomposition
.left-column[
Basic idea is to understand pathways of effects  

How much of the effect is due to $PM_{2.5}$ vs. other pathways?
]


---
# Basic DAG for mediation
.pull-left[
### $X$ = pre-treatment covariates
### $T$ = exposure
### $M$ = mediator
### $W$ = confounders
### $Y$ = outcome
]


---
# Basic DAG for mediation
.pull-left[
### $X$ = pre-treatment covariates
### $T$ = exposure
### $M$ = mediator
### $W$ = confounders
### $Y$ = outcome
]


---
# Quantities of interest
## Estimate two regressions:
$$\color{red}{E[Y|T,X]=\beta_{0}+\beta_{1}T +\beta_{2}X}$$
$$E[Y|T,X,M] = \gamma_{0} + \gamma_{1}T + \gamma_{2}M + \gamma_{3}TM + \gamma_{4}X + \gamma_{5}W$$

--

### First equation estimates the total effect of the ban:
$$\color{red}{TE=\beta_{1}(T^{*}-T)}$$
where $T^{*}$ is exposure to ban and $T$ is no exposure.

---
# Quantities of interest
## Estimate two regressions:
$$E[Y|T,X]=\beta_{0}+\beta_{1}T +\beta_{2}X$$
$$\color{red}{E[Y|T,X,M] = \gamma_{0} + \gamma_{1}T + \gamma_{2}M + \gamma_{3}TM + \gamma_{4}X + \gamma_{5}W}$$


### Second equation estimates the "Controlled Direct Effect":
$$\color{red}{CDE=\gamma_{1}+\gamma_{3}TM}$$

---
# Key assumptions
.right-column[
### Assumptions for valid CDE:
#### No confounding of the total effect.
#### No confounding of the mediator-outcome effect.
#### No confounding of the exposure-mediator effect.
]
---
# What the hell is the CDE?

.pull-left[
*This effect is the contrast between the counterfactual outcome if the individual were exposed at $T=t$ and the counterfactual outcome if the same individual were exposed at* $T=t*$, *with the mediator set to a fixed level* $M=m$.
]

--

.pull-right[
English:
### "By how much would blood pressure change if the policy were implemented and we held $PM_{2.5}$ fixed?"
]

---
.left-column[
### Extension to multiple mediators
More complicated

Sequential mediatiors?

Interactions between mediators?

]

