---
title: "Untitled"
author: "Sam Harper"
date: "29/10/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(here) 
library(tidyverse)
library(haven)
library(bacondecomp)
library(ggplot2)
library(fixest)
library(glue)
library(modelsummary)
library(TwoWayFEWeights)
library(kableExtra)
devtools::install_github("bcallaway11/did")
library(did)
```

First, let's read in the Stata dataset, and create a smaller version with just the variables of interest for looking at skilled birth attendance:
```{r d1, cache=TRUE}
d <- read_dta(here("data-clean", "hh_female_impact_rpt.dta")) %>%
    mutate(district = as_factor(hh1, levels = "labels"),
         time = as.numeric(delwave) + 1,
         sba_birth = as.numeric(sba_birth))

# restrict to variables for analysis
d_ind <- d %>% 
  select(district, sba_birth, txdel, time) %>%
  mutate(dist_id = as.numeric(district)) %>%
  drop_na() %>%
  group_by(district, dist_id) %>%
  mutate(group = min(if_else(txdel==1, time, 5)),
         g2 = if_else(group==2, 1, 0),
         g3 = if_else(group==3, 1, 0),
         g4 = if_else(group==4, 1, 0)) 
```

Next let's aggregate up to the district level
```{r d2, cache=TRUE}
d_sba <- d_ind %>%
  group_by(district, dist_id, time) %>%
  summarise(tsba = sum(sba_birth),
         tpop = n(),
         psba = tsba / tpop, # % SBA
         txdel = mean(txdel),
         group = mean(group),
         g2 = mean(g2),
         g3 = mean(g3),
         g4 = mean(g4))
glimpse(d_sba)
```

Since the CS DiD approach functions by aggregating different kinds of group-time DDs, we can also aggregate up to the group level, since we have 2 groups being treated at each wave post-baseline:

```{r gt}
# create group-time aggregate data
d_agg <- d_sba %>% group_by(group, time) %>%
  summarise(tsba = sum(tsba),
         tpop = sum(tpop),
         psba = tsba / tpop, # % SBA
         txdel = mean(txdel),
         g2 = mean(g2),
         g3 = mean(g3),
         g4 = mean(g4))
```

Now, just to get a look at what we are comparing when we run the group-time DDs, let's reshape this data to wide (just to see it):

```{r gtwide}
gt <- d_agg %>% select(group, time, psba) %>%
  pivot_wider(names_from = time, names_prefix = "time",
              values_from = psba)

gt %>%
  kbl(digits=3, escape = FALSE) %>%
  kable_styling()
```
The basic idea of the group-time ATTs is to estimate a series of ATTs for each group $G$ that is treated at time $T$. So if we wanted to estimate the ATT at time=2 for the group that is first treated at time=2, we calculate the 'long' difference, i.e., post minus pre for the treated group ($G=2$) and the difference for all groups *not already treated* for the same period. Thus, the groups we are comparing to estimate ATT(2,2) are:
```{r gt22}
gt %>%
  kbl(digits=3, escape = FALSE) %>%
  kable_styling() %>%
  column_spec(2:3, color = "black", background = "red") %>%
  row_spec(2:4, background  = "lightgray") %>%
  column_spec(4:6, background = "white") %>%
  column_spec(1, background = "white") %>%
  kable_minimal() %>%
  footnote(general = "Red = treated, Gray = untreated")
```

If we take the population-weighted average SBA proportions for these two groups, we get

```{r att22}
d_agg %>% filter(time < 3) %>%
  mutate(g22 = if_else(group==2,1,0)) %>%
  group_by(g22, time) %>%
  summarise(tsba = sum(tsba),
            tpop = sum(tpop),
            psba = tsba / tpop) %>%
  select(g22, time, psba) %>%
  pivot_wider(names_from = time, values_from = psba) %>%
  mutate(`Long diff` = `2` - `1`) %>%
  group_by() %>%
  mutate(ATT_2_2 = `Long diff` - lag(`Long diff`, default = NA)) %>%
  kable(digits=3) %>%
  column_spec(5, bold=TRUE) %>%
  kable_minimal()
```

Now, we can ask about how the effect in Group 2 changes with time after the intervention. The ATT(2,3) asks about the estimated treatment effect at time 3 ($t=3$) for the group that was first treated at time 2 ($g=2$). To get this estimate, we now create a similar 2x2 table but are using time 3 as the 'post' estimate. But note here that, since group 3 ($G=3$) is treated at time 3, we don't want to include it as a part of our control group, we that means we restrict our control comparison to only those groups that are **not** treated by time 3. So we are comparing:

```{r gt23}
gt %>%
  kbl(digits=3, escape = FALSE) %>%
  kable_styling() %>%
  column_spec(c(2,4), color = "black", background = "red") %>%
  row_spec(2, background = "white") %>%
  row_spec(3:4, background  = "lightgray") %>%
  column_spec(c(3,5,6), background = "white") %>%
  column_spec(1, background = "white") %>%
  kable_minimal() %>%
  footnote(general = "Red = treated, Gray = untreated")
```

And we get:
```{r att23}
d_agg %>% filter((time==1 | time==3) & group!=3) %>%
  mutate(g23 = if_else(group==2,1,0)) %>%
  group_by(g23, time) %>%
  summarise(tsba = sum(tsba),
            tpop = sum(tpop),
            psba = tsba / tpop) %>%
  select(g23, time, psba) %>%
  pivot_wider(names_from = time, values_from = psba) %>%
  mutate(`Long diff` = `3` - `1`) %>%
  group_by() %>%
  mutate(ATT_2_3 = `Long diff` - lag(`Long diff`, default = NA)) %>%
  kable(digits=3) %>%
  column_spec(5, bold=TRUE) %>%
  kable_minimal()
```

We can of course extend our view of how the treatment effect evolves for Group 2 by calculating the effect of being treated at time 4 for the group that was first treated at time 2, i.e., ATT(2,4). This is comparing:
```{r gt24}
gt %>%
  kbl(digits=3, escape = FALSE) %>%
  kable_styling() %>%
  column_spec(c(2,5), color = "black", background = "red") %>%
  row_spec(2:3, background = "white") %>%
  row_spec(4, background  = "lightgray") %>%
  column_spec(6, background = "white") %>%
  column_spec(c(1,3,4), background = "white") %>%
  kable_minimal() %>%
  footnote(general = "Red = treated, Gray = untreated")
```

Note that the control group here also changes, since at $t=4$ group 4 has now been treated, so we exclude them from the control group for this comparison. And the estimate is:
```{r att24}
d_agg %>% filter((time==1 | time==4) & group!=3 & group!=4) %>%
  mutate(g24 = if_else(group==2,1,0)) %>%
  group_by(g24, time) %>%
  summarise(tsba = sum(tsba),
            tpop = sum(tpop),
            psba = tsba / tpop) %>%
  select(g24, time, psba) %>%
  pivot_wider(names_from = time, values_from = psba) %>%
  mutate(`Long diff` = `4` - `1`) %>%
  group_by() %>%
  mutate(ATT_2_4 = `Long diff` - lag(`Long diff`, default = NA)) %>%
  kable(digits=3) %>%
  column_spec(5, bold=TRUE) %>%
  kable_minimal()
```

## Group 3
Now, what about the groups that are first treated at time 3, i.e., ($t=3$)? Since we actually have more than one pre-period for this group, we can also see whether there is some evidence of non-parallel trends by looking at, for example, the ATT(3,2), which is the effect of being treated at **time=2** for the group that is first treated at time 3. In essence, we are comparing the pre-intervention 'long difference' between $t=1$ and $t=2$ for the group eventually treated at time 3 with the same long difference among the controls:

```{r gt32}
gt %>%
  kbl(digits=3, escape = FALSE) %>%
  kable_styling() %>%
  column_spec(2:3, color = "black", background = "red") %>%
  row_spec(3:4, background  = "lightgray") %>%
  row_spec(1, background = "white") %>%
  column_spec(4:6, background = "white") %>%
  column_spec(1, background = "white") %>%
  kable_minimal() %>%
  footnote(general = "Red = treated, Gray = untreated")
```

The estimate of the ATT(3,2) is:
```{r att32}
d_agg %>% filter(time < 3 & group != 2) %>%
  mutate(g32 = if_else(group==3,1,0)) %>%
  group_by(g32, time) %>%
  summarise(tsba = sum(tsba),
            tpop = sum(tpop),
            psba = tsba / tpop) %>%
  select(g32, time, psba) %>%
  pivot_wider(names_from = time, values_from = psba) %>%
  mutate(`Long diff` = `2` - `1`) %>%
  group_by() %>%
  mutate(ATT_3_2 = `Long diff` - lag(`Long diff`, default = NA)) %>%
  kable(digits=3) %>%
  column_spec(5, bold=TRUE) %>%
  kable_minimal()
```

Now for the treatment effect at time 3 for the groups first treated at time 3 we are comparing:
```{r gt33}
gt %>%
  kbl(digits=3, escape = FALSE) %>%
  kable_styling() %>%
  column_spec(3:4, color = "black", background = "red") %>%
  row_spec(3:4, background  = "lightgray") %>%
  row_spec(1, background = "white") %>%
  column_spec(c(1,2,5,6), background = "white") %>%
  column_spec(1, background = "white") %>%
  kable_minimal() %>%
  footnote(general = "Red = treated, Gray = untreated")
```

The estimate of the ATT(3,3) is:
```{r att33}
d_agg %>% filter(time >1 & time < 4 & group != 2) %>%
  mutate(g33 = if_else(group==3,1,0)) %>%
  group_by(g33, time) %>%
  summarise(tsba = sum(tsba),
            tpop = sum(tpop),
            psba = tsba / tpop) %>%
  select(g33, time, psba) %>%
  pivot_wider(names_from = time, values_from = psba) %>%
  mutate(`Long diff` = `3` - `2`) %>%
  group_by() %>%
  mutate(ATT_3_3 = `Long diff` - lag(`Long diff`, default = NA)) %>%
  kable(digits=3) %>%
  column_spec(5, bold=TRUE) %>%
  kable_minimal()
```

The groups for comparison for the estimated treatment effect at time 4 for the groups first treated at time 3 now also need to exclude group 4, since it has received the treatment at time 4:
```{r gt34}
gt %>%
  kbl(digits=3, escape = FALSE) %>%
  kable_styling() %>%
  column_spec(4:5, color = "black", background = "red") %>%
  row_spec(c(1,3,4), background = "white") %>%
  row_spec(4, background  = "lightgray") %>%
  column_spec(c(1,2,3,6), background = "white") %>%
  kable_minimal() %>%
  footnote(general = "Red = treated, Gray = untreated")
```

The estimate of the ATT(3,3) is:
```{r att33}
d_agg %>% filter(time >1 & time < 4 & group != 2) %>%
  mutate(g33 = if_else(group==3,1,0)) %>%
  group_by(g33, time) %>%
  summarise(tsba = sum(tsba),
            tpop = sum(tpop),
            psba = tsba / tpop) %>%
  select(g33, time, psba) %>%
  pivot_wider(names_from = time, values_from = psba) %>%
  mutate(`Long diff` = `3` - `2`) %>%
  group_by() %>%
  mutate(ATT_3_3 = `Long diff` - lag(`Long diff`, default = NA)) %>%
  kable(digits=3) %>%
  column_spec(5, bold=TRUE) %>%
  kable_minimal()
```